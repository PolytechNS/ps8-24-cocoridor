<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../Game-Page/gamePage.css">
    <link rel="stylesheet" href="../global.css">

    <title>GamePage</title>
</head>
<body>
    <button class="chatbot-toggler">
        <span class="material-symbols-rounded">
            <img src="../Game-Page/chat.png" alt="chat" width="100%" height="100%">
        </span>
        <span class="material-symbols-outlined"></span>
      </button>
      <div class="chatbot">
        <header>
          <h2>Chatbot</h2>
          <span class="close-btn material-symbols-outlined"></span>
        </header>
        <ul class="chatbox">
          <li class="chat incoming">
            <span s="material-symbols-outlined">
                <img src="../Game-Page/PouletJ1.png" alt="PouletJ1" width="100%" height="100%">
            </span>
          </li>
        </ul>
        <div class="chat-input">
          <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
          <span id="send-btn" class="material-symbols-rounded">
            
          </span>
        </div>
      </div>

    <h1>Cocoridor</h1>
    <h2 id="playerplaying"></h2>
    <div id="playerTurn">
    </div>
    <div id ="gameDiv">
        <section id="game"></section>
        <section id = "gameCover" onclick="hideCover()"> </section>
    </div>
    <div>
        <button onclick="openChat()">
            chat
        </button>
    </div>
    <div id="chatPopup" style="display: none;">
        <textarea id="chatInput" placeholder="Entrez votre message"></textarea>
        <button onclick="sendMessage()">Envoyer</button>
        <button onclick="closeChat()">Fermer</button>
        <a href="../EndPage/endPage.html?winner=1">
            <button>gagner1</button>
        </a>
        <a href="../EndPage/endPage.html?winner=2">
            <button>gagner2</button>
        </a>
    </div>
    <h1 class="attente">En attente d'un joueur</h1>

    <img class ="attente" src="../Game-Page/polos.gif" alt="Loading">
    <button id="btnStart" >test</button>

    <a href="../index.html"><button >Annuler</button></a>

    <button id="btnChat" >message</button>
    <div id="messageButtons" style="display: none;">
        <button onclick="sendMessage('Bonjour')">Bonjour</button>
        <button onclick="sendMessage('Bonne chance!')">Bonne chance!</button>
        <button onclick="sendMessage('Bien joué!')">Bien joué!</button>
    </div>
    </br>
    <div id="messageBox"></div>
    <br>

    <button id="retour" onclick="window.location.href = '../index.html'">Retour</button>

    <script src="../Game-Page/gamePage.js"> </script>
    <script src="../js/socket.io.js"> </script>

    <script>
        function openChat() {
            document.getElementById("chatPopup").style.display = "block";
        }

        function closeChat() {
            document.getElementById("chatPopup").style.display = "none";
        }

        function sendMessage() {
            var message = document.getElementById("chatInput").value;
            console.log("Message envoyÃ© : " + message);
        }
        function hideCover() {
            document.getElementById("gameCover").style.display = "none";
        }
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const user = urlParams.get('playerid');
        let gameId = urlParams.get('gameid');
        let waiting = document.getElementsByClassName("attente");
        var socket;
        let gameSetUp = false;
        switch (mode) {
            case "local":
                socket=io('/api/Localgame');
                break;
            case "newAi":
                socket=io('/api/AIgame');
                socket.emit('newGame',user);
                break;
            case "getAi":
                socket=io('/api/AIgame');
                socket.emit('retrieveGame',user,gameId);
                break;
            case "1vs1":
                socket=io('/api/1vs1');

                for(let i=0;i<waiting.length;i++){
                    waiting[i].style.display = "block";
                }
                socket.emit('sendInfo',user);
                break;
            default:
                console.log("Mode inconnu");
                break;
        }
        socket.on("launch",(board,turnNb)=>{
            gameSetUp=false;
            init(board,mode,turnNb);
            DisplayBoard(board);
            for(let i=0;i<waiting.length;i++){
                waiting[i].style.display = "none";
            }
        })
        socket.on("initChoosePos",(gameId)=>{
            console.log("initChoosePos");
            socket.emit('askForInitPos',gameId);
        })
        socket.on("choosePos",(boardPos,playerL,turnNumber)=>{
            turnNb = turnNumber
            gameSetUp=true;
            console.log(playerList)
            playerList = playerL;
            DisplayBoard(boardPos.Board,boardPos.Positions);
        })
        socket.on("playersReady",()=>{
            console.log("playersReady");
            socket.emit('start');
        })
        socket.on("moved",()=>{
            socket.emit('update');
        })
        socket.on("updateBoard",(board,turnNumber)=>{
            turnNb=turnNumber;
            DisplayBoard(board);
        })
        socket.on("endGame",(winners)=>{
            if(winners.length==1)window.location.href = "../EndPage/endPage.html?winner="+winners[0];
            else window.location.href = "../EndPage/endPage.html?winner=0"
        })


        document.getElementById("btnChat").addEventListener('click', function() {
            var messageButtons = document.getElementById("messageButtons");
            messageButtons.style.display = 'block'; // Affiche les boutons de messages
        });

        function sendMessage(message) {
            console.log("Message envoyé: " + message);
            socket.emit('sendMessage', message); // Envoyez le message à l'adversaire via socket.io
        }

        socket.on('receiveMessage', function(message) {
            console.log("Message reçu: " + message);
            let messageBox = document.getElementById("messageBox");
            let messageElement = document.createElement("p");
            messageElement.textContent = message;
            messageBox.appendChild(messageElement);
        });

        

    </script>
</body>
</html>